<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin Panel - FullStreamRec</title>

  <link rel="icon" type="image/x-icon" href="logo.ico">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            brand: {
              DEFAULT: '#ff5e66',
              hover: '#ff444d',
              dark: '#cc4b52'
            },
            dark: {
              950: '#09090b',
              900: '#121214',
              800: '#1c1c1f',
              700: '#27272a',
              600: '#3f3f46'
            }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #09090b; }
    /* Scrollbar personalizada */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #18181b; }
    ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #52525b; }
  </style>
</head>
<body class="text-zinc-100 antialiased h-screen flex overflow-hidden bg-dark-950">

  <div id="sidebar-overlay" class="fixed inset-0 bg-black/80 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

  <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-72 bg-dark-900 border-r border-white/5 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-50 flex flex-col">
    <div class="h-20 flex items-center px-8 border-b border-white/5">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-brand flex items-center justify-center text-white font-bold shadow-lg shadow-brand/20">
          <i class="fas fa-stream"></i>
        </div>
        <span class="text-xl font-bold tracking-tight">FullStream<span class="text-brand">Rec</span></span>
      </div>
    </div>

    <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
      <a href="#" class="flex items-center gap-4 px-4 py-3.5 rounded-xl bg-brand/10 text-brand font-medium border border-brand/10 transition-all">
        <i class="fas fa-box w-5 text-center"></i>
        <span>Productos</span>
      </a>
    </nav>

    <div class="p-4 border-t border-white/5 bg-dark-800/30">
      <div class="flex items-center gap-3 mb-4 px-2">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-zinc-700 to-zinc-800 flex items-center justify-center text-white font-bold border border-white/10" id="user-avatar">A</div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-white truncate">Admin</p>
          <p class="text-xs text-zinc-500 truncate" id="user-email">admin@fullstreamrec.com</p>
        </div>
      </div>
      <button id="logout-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg border border-zinc-700 text-zinc-400 hover:bg-dark-800 hover:text-white hover:border-zinc-600 transition-all text-sm font-medium">
        <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
      </button>
    </div>
  </aside>

  <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
    
    <header class="h-20 bg-dark-950/80 backdrop-blur-md border-b border-white/5 flex items-center justify-between px-4 lg:px-8 z-30">
      <div class="flex items-center gap-4">
        <button id="mobile-menu-btn" class="lg:hidden p-2 text-zinc-400 hover:text-white rounded-lg">
          <i class="fas fa-bars text-xl"></i>
        </button>
        <h1 class="text-2xl font-bold text-white hidden sm:block">Administrar Productos</h1>
      </div>
      
      <div class="flex items-center gap-4">
        <button id="add-product-btn" class="bg-brand hover:bg-brand-hover text-white px-5 py-2.5 rounded-xl font-medium shadow-lg shadow-brand/20 flex items-center gap-2 transition-all active:scale-95">
          <i class="fas fa-plus"></i>
          <span class="hidden sm:inline">Nuevo Producto</span>
        </button>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth">
      <div class="max-w-7xl mx-auto">
        
        <div class="flex flex-col sm:flex-row gap-4 justify-between items-center mb-8 bg-dark-900/50 p-2 rounded-2xl border border-white/5">
          <div class="relative w-full sm:max-w-md">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500"></i>
            <input type="text" id="search-input" placeholder="Buscar por nombre o categoría..." 
                   class="w-full bg-dark-800 border border-zinc-700 text-white text-sm rounded-xl pl-11 pr-4 py-3 focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand placeholder-zinc-600 transition-all">
          </div>
          
          <div class="flex bg-dark-800 p-1 rounded-xl w-full sm:w-auto filter-buttons" id="filter-container">
             </div>
        </div>

        <div class="bg-dark-900 border border-white/5 rounded-2xl overflow-hidden shadow-xl">
          <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
              <thead>
                <tr class="bg-dark-800/50 border-b border-white/5 text-zinc-400 text-xs uppercase tracking-wider">
                  <th class="p-5 font-semibold">Logo</th>
                  <th class="p-5 font-semibold">Producto</th>
                  <th class="p-5 font-semibold">Categoría</th>
                  <th class="p-5 font-semibold text-center">Planes</th>
                  <th class="p-5 font-semibold text-center">Estado</th>
                  <th class="p-5 font-semibold text-right">Acciones</th>
                </tr>
              </thead>
              <tbody id="products-table-body" class="divide-y divide-white/5">
                <tr>
                  <td colspan="6" class="p-8 text-center text-zinc-500 animate-pulse">Cargando datos...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </main>
  </div>

  <div id="product-modal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>
    <div class="relative w-full h-full flex items-center justify-center p-4">
      <div class="bg-dark-900 border border-zinc-700 w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        
        <div class="flex items-center justify-between p-6 border-b border-white/5 bg-dark-800/50">
          <h3 class="text-xl font-bold text-white" id="modal-title">Agregar Producto</h3>
          <button id="close-modal" class="text-zinc-400 hover:text-white bg-dark-700 hover:bg-red-500/20 hover:text-red-500 p-2 rounded-lg transition-colors">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>

        <div class="p-6 overflow-y-auto flex-1 space-y-6 scrollbar-hide">
          <form id="product-form" class="space-y-6">
            <input type="hidden" id="product-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="space-y-2">
                <label class="text-sm font-medium text-zinc-400">Nombre del Producto</label>
                <input type="text" id="product-name" class="w-full bg-dark-950 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:border-brand focus:outline-none transition-all" required>
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-zinc-400">Categoría</label>
                <select id="product-category" class="w-full bg-dark-950 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:border-brand focus:outline-none transition-all appearance-none" required>
                  <option value="">Seleccionar...</option>
                  <option value="Streaming de Video">Streaming de Video</option>
                  <option value="IPTV">IPTV</option>
                  <option value="Música">Música</option>
                  <option value="Videojuegos">Videojuegos</option>
                  <option value="Herramientas Creativas">Herramientas Creativas</option>
                  <option value="Combos">Combos</option>
                </select>
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-zinc-400">URL del Logo</label>
              <div class="flex gap-3">
                <input type="url" id="product-logo" class="flex-1 bg-dark-950 border border-zinc-700 rounded-lg px-4 py-3 text-white focus:border-brand focus:outline-none transition-all" required>
                <div class="w-12 h-12 bg-dark-800 rounded-lg border border-zinc-700 flex items-center justify-center shrink-0 overflow-hidden">
                   <img id="logo-preview" src="" onerror="this.style.display='none'" class="w-full h-full object-contain p-1">
                   <i class="fas fa-image text-zinc-600" id="logo-placeholder"></i>
                </div>
              </div>
            </div>
            <div class="border-t border-white/5 pt-6">
              <div class="flex justify-between items-center mb-4">
                <label class="text-sm font-bold text-white uppercase tracking-wider">Planes y Precios</label>
                <button type="button" id="add-plan-btn" class="text-xs bg-dark-800 hover:bg-brand/20 hover:text-brand border border-zinc-700 hover:border-brand text-white px-3 py-1.5 rounded-lg transition-all">
                  <i class="fas fa-plus mr-1"></i> Agregar Plan
                </button>
              </div>
              <div id="plans-container" class="space-y-3"></div>
            </div>
          </form>
        </div>

        <div class="p-5 border-t border-white/5 bg-dark-800/50 flex justify-end gap-3">
          <button id="cancel-btn" class="px-5 py-2.5 rounded-xl border border-zinc-600 text-zinc-300 hover:bg-dark-700 hover:text-white transition-all font-medium">Cancelar</button>
          <button id="save-btn" class="px-6 py-2.5 rounded-xl bg-brand hover:bg-brand-hover text-white shadow-lg shadow-brand/20 font-bold transition-all active:scale-95">Guardar Producto</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

  <script>
    // --- Configuración Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCGhcDEti7CWmFFx1iVU_wyKuqN4q2hYeQ",
      authDomain: "site-fullstreamrec.firebaseapp.com",
      projectId: "site-fullstreamrec",
      storageBucket: "site-fullstreamrec.appspot.com",
      messagingSenderId: "161679433276",
      appId: "1:161679433276:web:2ecedce7e76a33ecfe6d39"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- Variables Globales ---
    let products = [];
    let currentProductId = null;
    let isEditing = false;
    let currentFilter = 'all'; // Estado global del filtro
    const categoryOrder = ["Streaming de Video", "IPTV", "Música", "Videojuegos", "Herramientas Creativas", "Combos"];

    // --- Elementos DOM ---
    const tableBody = document.getElementById('products-table-body');
    const searchInput = document.getElementById('search-input');
    const modal = document.getElementById('product-modal');
    const plansContainer = document.getElementById('plans-container');
    const productForm = document.getElementById('product-form');
    const filterContainer = document.getElementById('filter-container');

    // --- Sidebar Mobile Logic ---
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');

    function toggleSidebar() {
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('hidden');
    }

    mobileMenuBtn.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', toggleSidebar);

    // --- Lógica de Filtrado Unificada ---
    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        
        let filtered = products.filter(p => {
            // Filtro por texto
            const matchesSearch = p.name.toLowerCase().includes(searchTerm) || 
                                  p.category.toLowerCase().includes(searchTerm);
            
            // Filtro por estado (Tab)
            let matchesStatus = true;
            if (currentFilter === 'visible') matchesStatus = p.visible !== false; // Default true
            if (currentFilter === 'hidden') matchesStatus = p.visible === false;

            return matchesSearch && matchesStatus;
        });

        renderTable(filtered);
    }

    // --- Renderizado de Tabla ---
    function renderTable(data) {
        // Ordenar por categoría
        data.sort((a, b) => categoryOrder.indexOf(a.category) - categoryOrder.indexOf(b.category));

        tableBody.innerHTML = '';

        if (data.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="p-8 text-center text-zinc-500">
                        <div class="flex flex-col items-center justify-center">
                            <i class="fas fa-box-open text-4xl mb-3 opacity-20"></i>
                            <p>No se encontraron productos</p>
                        </div>
                    </td>
                </tr>`;
            return;
        }

        data.forEach(p => {
            const isHidden = p.visible === false;
            const row = document.createElement('tr');
            // Estilos condicionales si está oculto
            row.className = `group hover:bg-white/5 transition-colors border-b border-white/5 ${isHidden ? 'bg-red-900/10' : ''}`;
            
            row.innerHTML = `
                <td class="p-4">
                    <div class="w-12 h-12 rounded-lg bg-dark-800 border border-white/10 flex items-center justify-center overflow-hidden p-1">
                        <img src="${p.logo}" class="w-full h-full object-contain ${isHidden ? 'grayscale opacity-50' : ''}" onerror="this.src='https://fakeimg.pl/50x50?text=Error'">
                    </div>
                </td>
                <td class="p-4">
                    <p class="font-bold text-white text-sm ${isHidden ? 'text-zinc-500 line-through' : ''}">${p.name}</p>
                </td>
                <td class="p-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-dark-800 border border-white/10 text-zinc-300 whitespace-nowrap">
                        ${p.category}
                    </span>
                </td>
                <td class="p-4 text-center">
                    <span class="text-sm font-bold text-brand">${p.plans ? p.plans.length : 0}</span>
                </td>
                <td class="p-4 text-center">
                    <span class="px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${isHidden ? 'bg-zinc-800 text-zinc-500 border border-zinc-700' : 'bg-green-500/10 text-green-400 border border-green-500/20'}">
                        ${isHidden ? 'Oculto' : 'Visible'}
                    </span>
                </td>
                <td class="p-4 text-right">
                    <div class="flex items-center justify-end gap-2">
                        <button onclick="editProduct('${p.id}')" class="w-8 h-8 rounded-lg bg-dark-800 hover:bg-blue-500/20 hover:text-blue-400 text-zinc-400 transition-colors flex items-center justify-center" title="Editar">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                        <button onclick="toggleVisibility('${p.id}', ${isHidden})" class="w-8 h-8 rounded-lg bg-dark-800 hover:bg-yellow-500/20 hover:text-yellow-400 text-zinc-400 transition-colors flex items-center justify-center" title="${isHidden ? 'Mostrar' : 'Ocultar'}">
                            <i class="fas ${isHidden ? 'fa-eye-slash' : 'fa-eye'} text-xs"></i>
                        </button>
                        <button onclick="deleteProduct('${p.id}')" class="w-8 h-8 rounded-lg bg-dark-800 hover:bg-red-500/20 hover:text-red-400 text-zinc-400 transition-colors flex items-center justify-center" title="Eliminar">
                            <i class="fas fa-trash text-xs"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // --- Inicialización Filtros ---
    function initFilterButtons() {
        filterContainer.innerHTML = '';
        const filters = [
            { id: 'all', label: 'Todos' },
            { id: 'visible', label: 'Visibles' },
            { id: 'hidden', label: 'Ocultos' }
        ];

        filters.forEach(f => {
            const btn = document.createElement('button');
            // Estilo base
            let baseClass = 'flex-1 sm:flex-none px-4 py-2 rounded-lg text-xs font-medium transition-all border border-transparent ';
            // Estado activo vs inactivo
            if (currentFilter === f.id) {
                baseClass += 'bg-brand text-white shadow-lg shadow-brand/20 border-brand';
            } else {
                baseClass += 'text-zinc-400 hover:text-white hover:bg-dark-700 border-zinc-800';
            }
            
            btn.className = baseClass;
            btn.textContent = f.label;
            
            btn.onclick = () => {
                currentFilter = f.id; // Actualizar estado global
                initFilterButtons();  // Re-renderizar botones para actualizar clases
                applyFilters();       // Aplicar filtros
            };
            filterContainer.appendChild(btn);
        });
    }

    // --- Carga de Datos ---
    async function loadProducts() {
        try {
            // Mostrar loading temporal
            if(products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-zinc-500 animate-pulse">Cargando datos...</td></tr>';
            }
            
            const snap = await db.collection("products").get();
            products = snap.docs.map(doc => ({ 
                id: doc.id, 
                visible: doc.data().visible !== false, // Normalizar visible: undefined = true
                ...doc.data() 
            }));
            
            applyFilters(); // Usar la función unificada en lugar de render directo
            initFilterButtons(); // Asegurar que los botones estén pintados
        } catch (e) {
            console.error("Error cargando productos:", e);
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500 p-4">Error al cargar datos</td></tr>';
        }
    }

    // --- Acciones CRUD ---
    
    // 1. Toggle Visibility (CORREGIDO)
    window.toggleVisibility = async (id, newState) => {
        // newState viene como TRUE si estaba oculto (queremos mostrarlo)
        // o FALSE si estaba visible (queremos ocultarlo)
        // La lógica en el HTML onclick ya envía el valor opuesto al actual.
        
        // Optimistic UI Update (actualizar localmente antes de DB para velocidad)
        const pIndex = products.findIndex(p => p.id === id);
        if(pIndex !== -1) {
            products[pIndex].visible = newState;
            applyFilters(); // Re-renderizar inmediatamente
        }

        try {
            await db.collection("products").doc(id).update({ visible: newState });
            // No hace falta recargar todo loadProducts() si ya actualizamos local
        } catch(e) {
            console.error(e);
            alert("Error al actualizar estado");
            // Revertir si falla
            if(pIndex !== -1) {
                products[pIndex].visible = !newState;
                applyFilters();
            }
        }
    };

    // 2. Delete
    window.deleteProduct = async (id) => {
        if(!confirm('¿Estás seguro de eliminar este producto permanentemente?')) return;
        try {
            await db.collection("products").doc(id).delete();
            products = products.filter(p => p.id !== id); // Actualizar local
            applyFilters();
        } catch (e) {
            alert("Error al eliminar: " + e.message);
        }
    };

    // 3. Edit
    window.editProduct = (id) => {
        const p = products.find(x => x.id === id);
        if(!p) return;
        
        isEditing = true;
        currentProductId = id;
        document.getElementById('product-name').value = p.name;
        document.getElementById('product-category').value = p.category;
        document.getElementById('product-logo').value = p.logo;
        
        document.getElementById('product-logo').dispatchEvent(new Event('input'));

        plansContainer.innerHTML = '';
        if(p.plans) {
            p.plans.sort((a,b) => (a.order || 0) - (b.order || 0)).forEach(plan => {
                addPlanToForm(plan.name, plan.price, plan.image);
            });
        }
        
        showModal(true);
        new Sortable(plansContainer, { animation: 150, handle: '.drag-handle' });
    };

    // --- Formularios y Modales ---
    
    function addPlanToForm(name = '', price = '', image = '') {
        const div = document.createElement('div');
        div.className = 'plan-item bg-dark-950 border border-zinc-800 p-3 rounded-xl flex flex-col gap-3 relative group hover:border-zinc-700 transition-colors';
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="drag-handle cursor-move text-zinc-600 hover:text-zinc-400 p-2">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <div class="flex-1 grid grid-cols-2 gap-3">
                    <input type="text" class="plan-name bg-dark-900 border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand focus:outline-none" placeholder="Nombre del Plan" value="${name}" required>
                    <input type="text" class="plan-price bg-dark-900 border border-zinc-700 rounded-lg px-3 py-2 text-sm text-white focus:border-brand focus:outline-none" placeholder="Precio (ej: $5.00)" value="${price}" required>
                </div>
                <button type="button" class="remove-plan text-zinc-500 hover:text-red-500 p-2 rounded-lg hover:bg-red-500/10 transition-colors">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="flex items-center gap-3 pl-8">
                <div class="w-8 h-8 bg-dark-900 rounded border border-zinc-700 flex items-center justify-center overflow-hidden shrink-0">
                    <img src="${image}" class="plan-img-preview w-full h-full object-contain" onerror="this.style.display='none'">
                    <i class="fas fa-image text-xs text-zinc-600 ${image ? 'hidden' : ''}"></i>
                </div>
                <input type="url" class="plan-image flex-1 bg-dark-900 border border-zinc-700 rounded-lg px-3 py-1.5 text-xs text-zinc-300 focus:border-brand focus:outline-none" placeholder="URL Imagen del Plan (Opcional)" value="${image}">
            </div>
        `;

        const urlInput = div.querySelector('.plan-image');
        const imgPreview = div.querySelector('.plan-img-preview');
        const iconPlaceholder = div.querySelector('.fa-image');
        
        urlInput.addEventListener('input', (e) => {
            if(e.target.value) {
                imgPreview.src = e.target.value;
                imgPreview.style.display = 'block';
                iconPlaceholder.classList.add('hidden');
            } else {
                imgPreview.style.display = 'none';
                iconPlaceholder.classList.remove('hidden');
            }
        });

        div.querySelector('.remove-plan').onclick = () => div.remove();
        plansContainer.appendChild(div);
    }

    document.getElementById('save-btn').onclick = async (e) => {
        e.preventDefault();
        if(!productForm.checkValidity()) {
            productForm.reportValidity();
            return;
        }

        const plans = [];
        document.querySelectorAll('.plan-item').forEach((el, index) => {
            plans.push({
                name: el.querySelector('.plan-name').value,
                price: el.querySelector('.plan-price').value,
                image: el.querySelector('.plan-image').value,
                order: index
            });
        });

        if(plans.length === 0) {
            alert("Agrega al menos un plan.");
            return;
        }

        const data = {
            name: document.getElementById('product-name').value,
            category: document.getElementById('product-category').value,
            logo: document.getElementById('product-logo').value,
            plans: plans,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if(isEditing) {
                // Mantener visibilidad original
                const oldP = products.find(p => p.id === currentProductId);
                data.visible = oldP ? oldP.visible : true;
                
                await db.collection("products").doc(currentProductId).update(data);
            } else {
                data.visible = true;
                await db.collection("products").add(data);
            }
            hideModal();
            loadProducts(); // Recargar completo para asegurar sync
        } catch(e) {
            alert("Error al guardar: " + e.message);
        }
    };

    // --- Helpers UI ---
    function showModal(edit = false) {
        modal.classList.remove('hidden');
        document.getElementById('modal-title').textContent = edit ? 'Editar Producto' : 'Agregar Producto';
        document.getElementById('logo-preview').style.display = 'none';
        document.getElementById('logo-placeholder').style.display = 'block';
    }

    function hideModal() {
        modal.classList.add('hidden');
        productForm.reset();
        plansContainer.innerHTML = '';
        currentProductId = null;
        isEditing = false;
    }

    // Listeners
    searchInput.addEventListener('input', applyFilters);
    document.getElementById('add-product-btn').onclick = () => {
        isEditing = false;
        plansContainer.innerHTML = '';
        showModal(false);
        new Sortable(plansContainer, { animation: 150, handle: '.drag-handle' });
    };
    document.getElementById('add-plan-btn').onclick = () => addPlanToForm();
    document.getElementById('close-modal').onclick = hideModal;
    document.getElementById('cancel-btn').onclick = hideModal;
    document.getElementById('modal-backdrop').onclick = hideModal;
    
    document.getElementById('product-logo').addEventListener('input', function() {
        const url = this.value;
        const img = document.getElementById('logo-preview');
        const placeholder = document.getElementById('logo-placeholder');
        if(url) { img.src = url; img.style.display = 'block'; placeholder.style.display = 'none'; } 
        else { img.style.display = 'none'; placeholder.style.display = 'block'; }
    });

    // Auth
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').textContent = user.email.charAt(0).toUpperCase();
            loadProducts();
        } else {
            window.location.href = 'login.html';
        }
    });

    document.getElementById('logout-btn').onclick = () => {
        auth.signOut().then(() => window.location.href = 'login.html');
    };

  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
    }
  </style>
</body>
</html>