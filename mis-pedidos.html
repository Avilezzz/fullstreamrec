<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mis Pedidos - FullStreamRec</title>
  <link rel="icon" type="image/x-icon" href="logo.ico">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            brand: { DEFAULT: '#ff5e66', hover: '#ff444d', light: '#ff8a90' },
            dark: { 950: '#09090b', 900: '#121214', 800: '#1c1c1f', 700: '#27272a' }
          }
        }
      }
    }
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

  <style>body { background-color: #09090b; }</style>
</head>
<body class="text-zinc-100 antialiased selection:bg-brand/30 selection:text-white flex flex-col min-h-screen">

  <header class="fixed top-0 w-full z-50 bg-dark-950/80 backdrop-blur-xl border-b border-white/5">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16 md:h-20">
        <a href="index.html" class="flex items-center gap-3 group">
          <img src="logo.jpg" alt="FullStreamRec" class="h-10 w-10 rounded-lg object-cover">
          <span class="font-extrabold text-xl text-white">FullStream<span class="text-brand">Rec</span></span>
        </a>
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-sm font-medium text-zinc-400 hover:text-white transition-colors">Volver a la Tienda</a>
            <div class="h-8 w-8 rounded-full bg-brand/20 flex items-center justify-center text-brand border border-brand/50">
                <i class="fas fa-user"></i>
            </div>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-grow pt-32 pb-20 px-4 relative">
    <div class="absolute top-0 left-1/2 w-full -translate-x-1/2 h-[500px] bg-brand/5 rounded-full blur-[150px] pointer-events-none -z-10"></div>

    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-black text-white">Historial de <span class="text-brand">Pedidos</span></h1>
            <button onclick="loadMyOrders()" class="text-sm bg-dark-800 hover:bg-dark-700 text-white px-4 py-2 rounded-lg border border-white/10 transition-all">
                <i class="fas fa-sync-alt mr-2"></i> Actualizar
            </button>
        </div>

        <div id="orders-list" class="space-y-6">
            <div class="text-center py-20 text-zinc-500 animate-pulse">
                Cargando tu historial...
            </div>
        </div>
    </div>
  </main>

  <footer class="bg-dark-900 border-t border-white/5 py-8 text-center text-zinc-500 text-sm">
    &copy; 2025 FullStreamRec. Tus compras est谩n seguras con nosotros.
  </footer>

 <script>
    // 1. Configuraci贸n Firebase (Igual que antes)
    const firebaseConfig = {
      apiKey: "AIzaSyCGhcDEti7CWmFFx1iVU_wyKuqN4q2hYeQ",
      authDomain: "site-fullstreamrec.firebaseapp.com",
      projectId: "site-fullstreamrec",
      storageBucket: "site-fullstreamrec.appspot.com",
      messagingSenderId: "161679433276",
      appId: "1:161679433276:web:2ecedce7e76a33ecfe6d39"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // 2. Verificar Sesi贸n
    let currentUser = null;
    // Variable para guardar la suscripci贸n y poder cancelarla si fuera necesario
    let unsubscribeOrders = null; 

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            loadMyOrdersRealTime(); // <--- Llamamos a la nueva funci贸n
        } else {
            window.location.href = 'index.html';
        }
    });

    // 3. Funci贸n de Carga en Tiempo Real
    function loadMyOrdersRealTime() {
        const container = document.getElementById('orders-list');
        
        // Usamos onSnapshot en lugar de get()
        unsubscribeOrders = db.collection('orders')
            .where('userId', '==', currentUser.uid)
            .orderBy('date', 'desc')
            .onSnapshot((snapshot) => {
                
                // Si no hay pedidos
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="bg-dark-900/50 border border-white/5 rounded-2xl p-10 text-center animate-fade-in">
                            <div class="w-16 h-16 bg-dark-800 rounded-full flex items-center justify-center mx-auto mb-4 text-zinc-600">
                                <i class="fas fa-shopping-bag text-2xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-white mb-2">A煤n no tienes pedidos</h3>
                            <p class="text-zinc-400 mb-6">Tus compras aparecer谩n aqu铆.</p>
                            <a href="index.html" class="inline-block bg-brand hover:bg-brand-hover text-white font-bold py-3 px-6 rounded-xl transition-all">
                                Ir a la Tienda
                            </a>
                        </div>
                    `;
                    return;
                }

                let html = '';
                
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const orderId = doc.id;
                    // Manejo seguro de fechas (por si es reciente y a煤n no se ha guardado en servidor)
                    const dateData = order.date ? order.date.toDate() : new Date();
                    const dateStr = dateData.toLocaleDateString('es-EC', { day: 'numeric', month: 'long', hour: '2-digit', minute:'2-digit' });
                    
                    // --- 1. L贸gica de Colores de Estado ---
                    let statusClass = 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20';
                    let statusIcon = 'fa-clock';
                    
                    if (order.status === 'Completado') { 
                        statusClass = 'bg-green-500/10 text-green-500 border-green-500/20'; 
                        statusIcon = 'fa-check-circle'; 
                    }
                    if (order.status === 'Cancelado') { 
                        statusClass = 'bg-red-500/10 text-red-500 border-red-500/20'; 
                        statusIcon = 'fa-times-circle'; 
                    }

                    // --- 2. L贸gica del Bot贸n (Tu requerimiento principal) ---
                    let actionButtonHtml = '';

                    // Solo si est谩 Pendiente mostramos el bot贸n de WhatsApp
                    if (order.status === 'Pendiente') {
                        const whatsappMsg = encodeURIComponent(
                            `*Hola FullStreamRec!* \n` +
                            `Quiero finalizar el pago de mi pedido pendiente:\n` +
                            ` *ID:* ${orderId.slice(0,8)}\n` +
                            ` *Total:* ${order.totalFormatted}\n\n` +
                            `驴Me ayudas con los datos de dep贸sito?`
                        );
                        
                        const link = `https://api.whatsapp.com/send?phone=593978652638&text=${whatsappMsg}`;

                        actionButtonHtml = `
                            <div class="p-4 bg-dark-800/30 border-t border-white/5 flex justify-end">
                                <a href="${link}" target="_blank" class="inline-flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white px-5 py-2.5 rounded-xl font-bold text-sm transition-all shadow-lg shadow-green-900/20 hover:-translate-y-1 animate-pulse">
                                    <i class="fab fa-whatsapp text-lg"></i> Completar Pago
                                </a>
                            </div>
                        `;
                    }
                    // Si est谩 Completado o Cancelado, actionButtonHtml se queda vac铆o ('')

                    // --- 3. Generar HTML de los productos ---
                    let itemsHtml = order.items.map(item => `
                        <div class="flex items-center gap-4 py-3 border-b border-white/5 last:border-0">
                            <div class="h-12 w-12 rounded-lg bg-dark-800 p-1 border border-white/5 flex-shrink-0">
                                <img src="${item.productImage}" class="w-full h-full object-contain" onerror="this.src='logo.jpg'">
                            </div>
                            <div class="flex-1">
                                <p class="text-white font-bold text-sm">${item.productName}</p>
                                <p class="text-zinc-500 text-xs">${item.planName}</p>
                            </div>
                            <div class="text-zinc-300 font-medium text-sm">${item.planPrice}</div>
                        </div>
                    `).join('');

                    // --- 4. Armar la tarjeta completa ---
                    html += `
                        <div class="bg-dark-900 border border-white/10 rounded-2xl overflow-hidden hover:border-brand/30 transition-all shadow-lg animate-fade-in">
                            <div class="bg-dark-800/50 p-4 sm:p-6 flex flex-wrap gap-4 justify-between items-center border-b border-white/5">
                                <div>
                                    <p class="text-xs text-zinc-500 uppercase tracking-wider font-bold mb-1">Pedido #${orderId.slice(0,8)}</p>
                                    <p class="text-white font-medium text-sm"><i class="far fa-calendar-alt mr-2 text-brand"></i> ${dateStr}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold uppercase border flex items-center gap-2 ${statusClass}">
                                        <i class="fas ${statusIcon}"></i> ${order.status}
                                    </span>
                                    <p class="text-xl font-black text-white">${order.totalFormatted}</p>
                                </div>
                            </div>

                            <div class="p-4 sm:p-6 bg-dark-950/30">
                                ${itemsHtml}
                            </div>

                            ${actionButtonHtml}
                        </div>
                    `;
                });

                container.innerHTML = html;

            }, (error) => {
                console.error("Error en tiempo real:", error);
                // Si el error es de permisos, mostramos algo amigable
                if(error.code === 'permission-denied') {
                     container.innerHTML = '<p class="text-red-500 text-center py-10">Error de permisos. Intenta recargar la p谩gina o volver a iniciar sesi贸n.</p>';
                }
            });
    }
  </script>
</body>
</html>